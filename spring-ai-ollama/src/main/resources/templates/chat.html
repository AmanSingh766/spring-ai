<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChatGPT Clone UI</title>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <button id="newChatBtn">+ New Chat</button>

    <div id="history"></div>

    <div id="suggestions"></div>
</div>

<!-- MAIN CHAT AREA -->
<div id="main">
    <div id="chat-box"></div>

    <div id="input-box">
        <input id="input" placeholder="Send a message..." />

        <button id="fileBtn">üìÅ</button>
        <input type="file" id="fileInput" style="display:none" onchange="uploadFile()" />

        <button id="micBtn">üé§</button>
        <button id="sendBtn">Send</button>
    </div>
</div>

<script>
    let currentChatId = null;

    // Load chat list
    async function loadChatList() {
        const res = await fetch('/list');
        const chats = await res.json();

        const historyDiv = document.getElementById("history");
        historyDiv.innerHTML = "";

        chats.forEach(c => {
            historyDiv.innerHTML += `
                <div class="history-item">
                    <span onclick="openChat('${c.id}')">${c.title}</span>
                    <button class="delete-btn" onclick="deleteChat('${c.id}', event)">üóë</button>
                </div>
            `;
        });
    }

    // Open chat
    async function openChat(id) {
        currentChatId = id;

        const res = await fetch(`/load?id=${id}`);
        const chat = await res.json();

        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = "";

        chat.messages.forEach(msg => {
            const cls = msg.startsWith("You:") ? "user" : "bot";
            chatBox.innerHTML += `<div class="msg ${cls}">${msg}</div>`;
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Create new chat
    async function startNewChat() {
        const res = await fetch('/new?msg=New Chat Started', { method: "POST" });
        const chat = await res.json();

        currentChatId = chat.id;
        loadChatList();
        openChat(chat.id);
    }

    // Send message
    async function sendMessage() {
        if (!currentChatId) return alert("Click NEW CHAT first!");

        const input = document.getElementById("input");
        const text = input.value.trim();
        if (!text) return;

        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML += `<div class="msg user">You: ${text}</div>`;
        input.value = "";

        chatBox.innerHTML += `<div class="msg bot" id="typing">AI is typing...</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        const res = await fetch(`/chat?id=${currentChatId}&q=${encodeURIComponent(text)}`);
        const ans = await res.text();

        document.getElementById("typing").remove();

        chatBox.innerHTML += `<div class="msg bot">AI: ${ans}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        loadChatList();
    }

    // Delete chat
    async function deleteChat(id, event) {
        event.stopPropagation();
        await fetch(`/delete?id=${id}`, { method: "DELETE" });
        loadChatList();
    }

    // FILE UPLOAD ‚Üí AI Reads
    document.getElementById("fileBtn").onclick = () => {
        document.getElementById("fileInput").click();
    };

    async function uploadFile() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return;

        const form = new FormData();
        form.append("file", file);

        const res = await fetch("/upload", { method: "POST", body: form });
        const data = await res.text();

        const chatBox = document.getElementById("chat-box");

        chatBox.innerHTML += `<div class="msg user">üìÑ Uploaded: ${file.name}</div>`;
        chatBox.innerHTML += `<div class="msg bot">${data}</div>`;
    }

    // SPEECH TO TEXT
    let recognition;
    if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";

        recognition.onresult = function(event) {
            document.getElementById("input").value = event.results[0][0].transcript;
        };
    }

    document.getElementById("micBtn").onclick = () => {
        if (recognition) recognition.start();
    };

    // PROMPT SUGGESTIONS
    const suggestionList = [
        "Explain this in simple terms.",
        "Summarize the content.",
        "Give real-life examples.",
        "Improve my writing.",
        "Generate bullet points.",
        "Write code for this problem."
    ];

    function loadSuggestions() {
        const sugDiv = document.getElementById("suggestions");
        sugDiv.innerHTML = "<h3>Suggestions</h3>";

        suggestionList.forEach(s => {
            sugDiv.innerHTML += `<div class="suggestion" onclick="useSuggestion('${s}')">${s}</div>`;
        });
    }

    function useSuggestion(text) {
        document.getElementById("input").value = text;
    }

    // Event Listeners
    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("newChatBtn").onclick = startNewChat;

    document.getElementById("input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });

    loadChatList();
    loadSuggestions();
</script>

</body>
</html>
